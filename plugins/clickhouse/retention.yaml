documentationURL: ""
defaultExportURL: "username:password@clickhouse.obs.svc.cluster.local:9000/default"
allowCustomExportURL: true
allowInsecureTLS: true
presetScripts:
  - name: "dc snoop export"
    description: "This script exports data from the dentry cache snoop bpftrace script"
    script: |
      import pxtrace
      import px
      
      
      program = """
      #include <linux/fs.h>
      
      // from fs/namei.c:
      struct nameidata {
      				struct path     path;
      				struct qstr     last;
      				// [...]
      };
      
      // comment out this block to avoid showing hits:
      kprobe:lookup_fast,
      kprobe:lookup_fast.constprop.*
      {
      		$nd = (struct nameidata *)arg0;
      		printf(\"time_:%llu pid:%d comm:%s t:%s file:%s\",
      					 nsecs, pid, comm, \"R\", str($nd->last.name));
      }
      
      kprobe:d_lookup
      {
      		$name = (struct qstr *)arg1;
      		@fname[tid] = $name->name;
      }
      
      kretprobe:d_lookup
      /@fname[tid]/
      {
      		printf(\"time_:%llu pid:%d comm:%s t:%s file:%s\",
      					 nsecs, pid, comm, \"M\", str(@fname[tid]));
      		delete(@fname[tid]);
      }
      """
      
      
      table_name = 'dc_snoop'
      pxtrace.UpsertTracepoint('dc_snoop',
      												 table_name,
      												 program,
      												 pxtrace.kprobe(),
      												 "24h")
      df = px.DataFrame(table=table_name, start_time=px.plugin.start_time, end_time=px.plugin.end_time)
      px.export(df, px.otel.ClickHouseRows(table=table_name))
  - name: "conn_stats export"
    description: "This script exports data from the conn_stats table"
    script: |
      import px
      
      table_name = 'conn_stats'
      df = px.DataFrame(table=table_name, start_time=px.plugin.start_time, end_time=px.plugin.end_time)
      px.export(df, px.otel.ClickHouseRows(table=table_name))

  - name: "stack_traces export"
    description: "This script exports data from the stack_traces table"
    script: |
      import px
      
      df = px.DataFrame(table='stack_traces.beta', start_time=px.plugin.start_time, end_time=px.plugin.end_time)
      # TODO(ddelnano): Clickhouse thinks this is a namespaced table, fix this when possible
      px.export(df, px.otel.ClickHouseRows(table='stack_traces'))
